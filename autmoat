import asyncio
import tkinter as tk
from tkinter import simpledialog
from playwright.async_api import async_playwright, TimeoutError
import re

def solicitar_credenciales():
    root = tk.Tk()
    root.withdraw()
    usuario = simpledialog.askstring("Login", "Ingrese su usuario corporativo:")
    contraseña = simpledialog.askstring("Login", "Ingrese su contraseña:", show='*')
    return usuario, contraseña

async def seleccionar_parametros_kendo(page, filial, oficina, rol):
    try:
        # FILIAL
        filial_input = page.locator("input[name='filial_input']")
        await filial_input.click()
        await filial_input.fill(filial)
        await page.locator(f"li:has-text('{filial}')").wait_for(state="visible", timeout=5000)
        await page.locator(f"li:has-text('{filial}')").click()

        # OFICINA
        oficina_input = page.locator("input[name='office_input']")
        await oficina_input.click()
        await oficina_input.fill(oficina)
        await page.locator(f"li:has-text('{oficina}')").wait_for(state="visible", timeout=5000)
        await page.locator(f"li:has-text('{oficina}')").click()

        # ROL
        rol_input = page.locator("input[name='rol_input']")
        await rol_input.click()
        await rol_input.fill(rol)
        await page.locator(f"li:has-text('{rol}')").wait_for(state="visible", timeout=5000)
        await page.locator(f"li:has-text('{rol}')").click()

        print("✅ Parámetros seleccionados correctamente.")
    except Exception as e:
        print(f"❌ Error al seleccionar parámetros: {e}")
        

async def main():
    async with async_playwright() as p:
        browser = await p.chromium.launch(headless=False)
        context = await browser.new_context()
        page = await context.new_page()

        await page.goto("https://web-prod.core.appst.bancolombia.corp/CWC/services/cobis/web/bank/views/commons/login.html")
        await page.wait_for_load_state('domcontentloaded')

        try:
            await page.wait_for_selector('select', timeout=5000)
            print("Ya estás autenticado. Saltando al paso de selección.")
        except TimeoutError:
            print("No estás autenticado. Iniciando login con Microsoft.")
            await page.wait_for_selector('text=Microsoft', timeout=10000)
            await page.click('text=Microsoft')
            await page.wait_for_url(re.compile(r".*login\.microsoftonline\.com.*"), timeout=60000)

            usuario, contraseña = solicitar_credenciales()
            await page.wait_for_selector('input[type="email"]', timeout=60000)
            await page.fill('input[type="email"]', usuario)
            await page.press('input[type="email"]', 'Enter')

            await page.wait_for_selector('input[type="password"]', timeout=60000)
            await page.fill('input[type="password"]', contraseña)
            await page.wait_for_selector('input[type="submit"], button:has-text(\"Iniciar sesión\")', timeout=60000)
            await page.click('input[type="submit"], button:has-text(\"Iniciar sesión\")')

            await page.wait_for_url(re.compile(r".*core\.appst\.bancolombia\.corp.*"), timeout=60000)
            await page.wait_for_load_state('networkidle')

        try:
            # Parámetros de ejemplo
            filial = "BANISTMO S.A"
            oficina = "SERVICIOS CALL CENTER"
            rol = "CONSULTA SERVICIOS CALL CENTER"

            await seleccionar_parametros_kendo(page, filial, oficina, rol)

            print("Haciendo clic en 'Ingresar'...")
            ingresar_button = page.locator("button:has-text('Ingresar')")
            await ingresar_button.wait_for(state="visible", timeout=15000)
            await ingresar_button.click()
            print("✅ Clic en 'Ingresar' realizado.")

            # Clic en el botón de menú con título "Menú" y clase fa fa-bars
            try:
                menu_button = page.locator("a[title='Menú'] .fa.fa-bars")
                await menu_button.wait_for(state="visible", timeout=10000)
                await menu_button.click()
                print("✅ Clic en el botón de menú realizado.")
            except Exception as e:
                print(f"❌ Error al hacer clic en el botón de menú: {e}")
            

        except Exception as e:
            print("❌ Error al interactuar con los dropdowns o botón 'Ingresar':", e)
            

        await page.wait_for_timeout(15000)
        await browser.close()

if __name__ == "__main__":
    asyncio.run(main())
