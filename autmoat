import asyncio
import tkinter as tk
from tkinter import simpledialog
from playwright.async_api import async_playwright
import re

def solicitar_credenciales():
    root = tk.Tk()
    root.withdraw()
    usuario = simpledialog.askstring("Login", "Ingrese su usuario corporativo:")
    contraseña = simpledialog.askstring("Login", "Ingrese su contraseña:", show='*')
    root.destroy()
    return usuario, contraseña

async def main():
    async with async_playwright() as p:
        browser = await p.chromium.launch(headless=False)
        context = await browser.new_context()
        page = await context.new_page()
        await page.goto("https://web-prod.core.appst.bancolombia.corp/CWC/services/cobis/web/bank/views/commons/login.html")
        await page.wait_for_load_state('domcontentloaded')

        # Suponemos parte de login Microsoft u otro flujo
        # [...]
        # después de autenticarse, llegarás al formulario con los dropdowns Filial / Oficina / Rol

        # Esperar que los dropdowns “combobox” estén presentes
        # Por ejemplo, esperar que el componente que contiene la lista (antes de desplegar) esté presente
        await page.wait_for_selector("[aria-haspopup='listbox']", timeout=30000)

        # Para cada dropdown (Filial, Oficina, Rol), suponiendo que hay botones que despliegan la lista
        # Debes identificar el “activador” (el div o elemento que haces clic para desplegar)
        # Por ejemplo:
        #   <span class="k-dropdown-wrap k-state-default">…</span> o similar
        # Aquí supongamos que el activador tiene clase `.k-dropdown-wrap`; 
        activadores = page.locator(".k-dropdown-wrap")  
        ct = await activadores.count()
        for i in range(ct):
            act = activadores.nth(i)
            await act.wait_for(timeout=10000)
            await act.scroll_into_view_if_needed()
            await act.click()  # despliega la lista

            # Ahora buscar la lista desplegada asociada (ul / li)
            # Puedes usar el id del listbox que viste: `filialCombobox_listbox`
            # O usar un selector genérico: ul.k-list > li
            lista_items = page.locator("ul.k-list li.k-item")
            await lista_items.wait_for(timeout=10000)
            nitems = await lista_items.count()
            print("Items del dropdown desplegado:", nitems)
            if nitems > 0:
                # seleccionar el primero (o el único)
                await lista_items.nth(0).click()
            else:
                print("No se encontraron items")

        # Luego clic en botón Ingresar
        await page.wait_for_selector('button:has-text("Ingresar"), input[value="Ingresar"]', timeout=15000)
        await page.click('button:has-text("Ingresar"), input[value="Ingresar"]')

        await page.wait_for_timeout(5000)
        await browser.close()

if __name__ == "__main__":
    asyncio.run(main())
