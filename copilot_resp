import asyncio
import tkinter as tk
from tkinter import simpledialog
from playwright.async_api import async_playwright
import re

def solicitar_credenciales():
    root = tk.Tk()
    root.withdraw()
    usuario = simpledialog.askstring("Login", "Ingrese su usuario corporativo:")
    contraseña = simpledialog.askstring("Login", "Ingrese su contraseña:", show='*')
    return usuario, contraseña

async def main():
    async with async_playwright() as p:
        browser = await p.chromium.launch(headless=False)
        context = await browser.new_context()
        page = await context.new_page()

        await page.goto("https://web-prod.core.appst.bancolombia.corp/CWC/services/cobis/web/bank/views/commons/login.html")
        await page.wait_for_load_state('domcontentloaded')

        try:
            await page.wait_for_selector('select', timeout=5000)
            print("Ya estás autenticado. Saltando al paso de selección.")
        except:
            print("No estás autenticado. Iniciando login con Microsoft.")
            await page.wait_for_selector('text=Microsoft')
            await page.click('text=Microsoft')
            await page.wait_for_url(re.compile(r".*login\.microsoftonline\.com.*"), timeout=60000)
            usuario, contraseña = solicitar_credenciales()
            await page.wait_for_selector('input[type="email"]', timeout=60000)
            await page.fill('input[type="email"]', usuario)
            await page.press('input[type="email"]', 'Enter')
            await page.wait_for_selector('input[type="password"]', timeout=60000)
            await page.fill('input[type="password"]', contraseña)
            await page.wait_for_selector('input[type="submit"], button:has-text(\"Iniciar sesión\")', timeout=60000)
            await page.click('input[type="submit"], button:has-text(\"Iniciar sesión\")')
            await page.wait_for_url(re.compile(r".*core\.appst\.bancolombia\.corp.*"), timeout=60000)
            await page.wait_for_load_state('networkidle')

        await page.wait_for_selector('select', timeout=60000)
        dropdowns = await page.query_selector_all('select')
        for dropdown in dropdowns:
            options = await dropdown.query_selector_all('option')
            if len(options) == 1:
                value = await options[0].get_attribute('value')
                await dropdown.select_option(value=value)
            else:
                await dropdown.select_option(index=1)

        await page.click('text=Ingresar')
        await page.wait_for_timeout(5000)
        await browser.close()

asyncio.run(main())
